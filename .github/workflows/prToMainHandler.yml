name: PR to Main Handler

on:
  workflow_call:
    inputs:
      development_pr_number:
        required: true
        type: number
      development_pr_creator:
        required: true
        type: string
      reference_branch:
        required: false
        type: string
        default: "development"
    secrets:
      personal_access_token:
        required: true
      slack_bot_token:
        required: false

env:
  GITHUB_TOKEN: ${{ secrets.personal_access_token }}

jobs:
  pr_to_main_handler:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ${{ inputs.reference_branch }} code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.reference_branch }}
          fetch-depth: 0

      - name: Get the last commit SHA
        id: last_commit
        run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Extract branch prefix from PR
        id: branch_prefix
        run: |
          branch_name=$(gh pr view ${{ inputs.development_pr_number }} --json headRefName --jq '.headRefName')
          prefix=$(echo "$branch_name" | grep -oE '^[^-]+-[^-]+')
          echo "prefix=$prefix" >> $GITHUB_OUTPUT

      - name: Extract team from branch prefix
        id: team_extract
        run: |
          branch_name=$(gh pr view ${{ inputs.development_pr_number }} --json headRefName --jq '.headRefName')
          echo "Branch name: $branch_name"

          # Extract first segment before first hyphen
          team=$(echo "$branch_name" | grep -oE '^[^-]+' | tr '[:lower:]' '[:upper:]')
          echo "Extracted team: $team"
          echo "team=$team" >> $GITHUB_OUTPUT

          # Set a flag if team was successfully extracted
          if [ -n "$team" ]; then
            echo "has_team=true" >> $GITHUB_OUTPUT
          else
            echo "has_team=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Get PR comments, title and body
        id: pr_details
        run: |
          # Fetch PR data
          pr_data=$(gh pr view ${{ inputs.development_pr_number }} --json title,body,comments)

          # Extract title using heredoc delimiter for safe multiline/special char handling
          pr_title=$(echo "$pr_data" | jq -r '.title // ""')
          {
            echo "title<<EOFTITLE"
            echo "$pr_title"
            echo "EOFTITLE"
          } >> $GITHUB_OUTPUT

          # Extract body (keep original formatting, no <br> conversion needed)
          pr_body=$(echo "$pr_data" | jq -r '.body // ""')
          {
            echo "body<<EOFBODY"
            echo "$pr_body"
            echo "EOFBODY"
          } >> $GITHUB_OUTPUT

          # Extract parent comments
          pr_comments=$(echo "$pr_data" | jq -r '[.comments[]? | select(.body | startswith("/parent")) | .body] | join("\n")')
          {
            echo "comments<<EOFCOMMENTS"
            echo "$pr_comments"
            echo "EOFCOMMENTS"
          } >> $GITHUB_OUTPUT

      - name: Extract parent PR number (if any)
        id: parent_pr_number
        env:
          PR_COMMENTS: ${{ steps.pr_details.outputs.comments }}
        run: |
          parent_pr=$(echo "$PR_COMMENTS" | grep -oP '/parent #\K\d+' || true)
          echo "parent_pr=$parent_pr" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Set Git user
        run: |
          git config user.name "$(git log -n 1 --pretty=format:%an)"
          git config user.email "$(git log -n 1 --pretty=format:%ae)"

      - name: Checkout from main branch
        if: steps.parent_pr_number.outcome == 'failure'
        run: |
          git fetch origin main
          git checkout -b ${{ steps.branch_prefix.outputs.prefix }}-prod origin/main

      - name: Checkout from parent PR branch
        if: steps.parent_pr_number.outcome != 'failure'
        run: |
          parent_branch=$(gh pr view ${{ steps.parent_pr_number.outputs.parent_pr }} --json headRefName --jq '.headRefName')
          git fetch origin $parent_branch
          git checkout $parent_branch

      - name: Cherry-pick the last commit from ${{ inputs.reference_branch }}
        id: cherry_pick
        run: |
          git cherry-pick -m 1 ${{ steps.last_commit.outputs.sha }}
        continue-on-error: true

      - name: Commit conflicts if cherry pick fails
        if: ${{ steps.cherry_pick.outcome == 'failure' }}
        run: |
          git add .
          git commit --no-edit

      - name: Push branch
        run: |
          if [ "${{ steps.parent_pr_number.outcome }}" == "failure" ]; then
            git push origin ${{ steps.branch_prefix.outputs.prefix }}-prod
          else
            parent_branch=$(gh pr view ${{ steps.parent_pr_number.outputs.parent_pr }} --json headRefName --jq '.headRefName')
            git push origin HEAD:$parent_branch
          fi

      - name: Create pull request
        if: steps.parent_pr_number.outcome == 'failure'
        env:
          PR_TITLE: ${{ steps.pr_details.outputs.title }}
          PR_BODY: ${{ steps.pr_details.outputs.body }}
          PR_NUMBER: ${{ inputs.development_pr_number }}
          PR_CREATOR: ${{ inputs.development_pr_creator }}
          BRANCH_PREFIX: ${{ steps.branch_prefix.outputs.prefix }}
          LAST_COMMIT: ${{ steps.last_commit.outputs.sha }}
          REF_BRANCH: ${{ inputs.reference_branch }}
          CHERRY_PICK_FAILED: ${{ steps.cherry_pick.outcome == 'failure' }}
        run: |
          # Build the title (safe - passed via env var)
          FULL_TITLE="[Prod] ${PR_TITLE} - #${PR_NUMBER} by @${PR_CREATOR}"

          # Build the body and write to temp file to avoid shell escaping issues
          if [ "$CHERRY_PICK_FAILED" == "true" ]; then
            {
              echo ":warning: **This PR had conflicts with main. Make sure the changes are correct before proceeding.**"
              echo ""
              echo "---"
              echo ""
              echo "**Original PR Description:**"
              echo ""
              echo "$PR_BODY"
              echo ""
              echo "---"
              echo "This PR includes changes from commit ${LAST_COMMIT}, PR #${PR_NUMBER} in ${REF_BRANCH}."
            } > /tmp/pr_body.md
          else
            {
              echo "**Original PR Description:**"
              echo ""
              echo "$PR_BODY"
              echo ""
              echo "---"
              echo "This PR includes changes from commit ${LAST_COMMIT}, PR #${PR_NUMBER} in ${REF_BRANCH}."
            } > /tmp/pr_body.md
          fi

          # Create the PR using --body-file to avoid shell escaping issues
          gh pr create \
            -B main \
            -H "${BRANCH_PREFIX}-prod" \
            --title "$FULL_TITLE" \
            --body-file /tmp/pr_body.md \
            --assignee "$PR_CREATOR" \
            --draft

      - name: Determine Slack channel for team
        id: slack_channel
        if: failure() && steps.team_extract.outputs.has_team == 'true'
        env:
          SLACK_TOKEN: ${{ secrets.slack_bot_token }}
          TEAM: ${{ steps.team_extract.outputs.team }}
        run: |
          # Check if Slack token is provided
          if [ -z "$SLACK_TOKEN" ]; then
            echo "No Slack bot token provided, skipping notification"
            echo "has_channel=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          CHANNEL=""

          case "$TEAM" in
            "CRM")
              CHANNEL="crm-dev"
              ;;
            # Add more team-to-channel mappings here as needed:
            # "SALES")
            #   CHANNEL="sales-team"
            #   ;;
            *)
              echo "No channel mapping configured for team: $TEAM"
              ;;
          esac

          if [ -n "$CHANNEL" ]; then
            echo "channel=$CHANNEL" >> $GITHUB_OUTPUT
            echo "has_channel=true" >> $GITHUB_OUTPUT
          else
            echo "has_channel=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Send Slack notification on failure
        if: failure() && steps.slack_channel.outputs.has_channel == 'true'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.slack_bot_token }}
          payload: |
            {
              "channel": "${{ steps.slack_channel.outputs.channel }}",
              "text": "PR to Main Workflow Failed - Team ${{ steps.team_extract.outputs.team }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ùå PR to Main Workflow Failed",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Team:*\n${{ steps.team_extract.outputs.team }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*PR Number:*\n<${{ github.server_url }}/${{ github.repository }}/pull/${{ inputs.development_pr_number }}|#${{ inputs.development_pr_number }}>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Creator:*\n@${{ inputs.development_pr_creator }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ steps.branch_prefix.outputs.prefix }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*PR Title:*\n${{ steps.pr_details.outputs.title }}"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "style": "danger",
                      "text": {
                        "type": "plain_text",
                        "text": "View Failed Workflow Run",
                        "emoji": true
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Original PR",
                        "emoji": true
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/pull/${{ inputs.development_pr_number }}"
                    }
                  ]
                }
              ]
            }
        continue-on-error: true
